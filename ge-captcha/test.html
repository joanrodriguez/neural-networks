<html>

  <head>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script>

      $(detect);

      function detect(){

        var img = $('img')[0];

        var threshold = 80;

        // create canvas for processing
        var c = document.createElement("canvas");
        var ctx = c.getContext("2d");
        c.width = img.width;
        c.height= img.height;
        // draw image on canvas
        ctx.drawImage(img, 0, 0);
        // retrieve data from canvas
        var data = [].slice.call(ctx.getImageData(0,0,img.width,img.height).data);

        // First we traverse the image from left to right through the middle
        // looking for black pixels
        var middle = 4*Math.floor(img.height/2)*img.width;
        for(var i = middle; i<data.length; i = i+4){
          if(data[i]<threshold){
            // Found a black pixel, now discover the letter
            fillLetter(i);
          }
        }

        // "Paint bucket" algorithm that starts with a point in the canvas
        // and finds all adjacent black pixels
        function fillLetter(i){

          // Create a canvas to draw the discovered letter on
          var c = document.createElement("canvas");
          var ctx = c.getContext("2d");
          c.width = img.width;
          c.height= img.height;

          // Get x and y of black pixel from index
          var x = ix(i,img.width);
          var y = iy(i,img.width);

          // Add our starting pixel to the stack
          var pixelStack = [[x,y]];

          // Loop through the stack which gets augmented as we discover pixels
          while(pixelStack.length){

            var newPos, x, y, pixelPos, reachLeft, reachRight;

            // newPos is temporary and only used here
            newPos = pixelStack.pop();
            x = newPos[0];
            y = newPos[1];

            // pixelPos is the index in the array
            var pixelPos = xyi(x,y,img.width);

            // Go up until no more black
            while(y>= 0 && data[pixelPos-img.width*4]<threshold){
              y--;
              pixelPos -= img.width * 4;
            }

            // Then go down as long as there is black
            while(y < img.height && data[pixelPos]<threshold){

              ctx.fillRect(x,y,1,1);
              data.splice(pixelPos, 4, 255, 255, 255, 255);

              pixelPos += img.width*4;
              y++;
              reachLeft = false;
              reachRight = false;

              // Look left
              if(x > 0)
              {
                if(data[pixelPos-4]<threshold)
                {
                  if(!reachLeft){
                    pixelStack.push([x - 1, y]);
                    reachLeft = true;
                  }
                }
                else if(reachLeft)
                {
                  reachLeft = false;
                }
              }


              console.log("Time to look right maybe");
              // Look right
              if(x < img.width-1)
              {
                console.log("we are not at the end of pic, let's look");
                if(data[pixelPos+4]<threshold)
                {
                  console.log("The pixel to our right is black, do we anchor?");
                  if(!reachRight)
                  {
                    console.log("Done, we have anchored");
                    pixelStack.push([x + 1, y]);
                    reachRight = true;
                  }
                }
                else if(reachRight)
                {
                  console.log("The pixel on our right was white so we stoped looking");
                  reachRight = false;
                }
              }


            }
          }
          $('body').append(c);
          console.log(c);
        }

        function ix(i,w){
          return Math.floor(i/4)%w;
        }

        function iy(i,w){
          return Math.floor(i/(4*w));
        }

        function xyi(x,y,w){
          return (y*w + x) * 4;
        }

      }
    </script>
  </head>
  <body>
    <img src="captchas/7.jpeg" />
  </body>
</html>